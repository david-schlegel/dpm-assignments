---
title: "Plot Assignment"
subtitle: "Data processing"
author: "David Schlegel"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}

knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

```

# Dependencies

```{r}

library(tidyverse)
library(janitor) 
library(stringr)
library(openxlsx)
library(ggplot2)
library(ggbeeswarm)
library(introdataviz)
```

# Get data

```{r}

# demographics
data_raw <- read_delim("../data/raw/data_raw_reactiontime.csv",
                       delim = ";", 
                       locale = locale(decimal_mark = ".", grouping_mark = ","),
                       col_types = cols()) |> 
  janitor::clean_names()

```

# Data wrangling

```{r}
data_raw <- data_raw |> 
  mutate(recall_score = as.numeric(recall_score))


```

# Exclusions / data quality

## AMP

```{r}
data_raw |>
  group_by(age_group, test_condition) |>
  summarise(mean = mean(recall_score))
  
```
## Plot
```{r}


# Setting the height for the rain elements
rain_height <- .1

# Create the Raincloud plot
ggplot(data_raw, aes(x = "", y = recall_score, fill = age_group)) +
  # Clouds
  geom_flat_violin(trim=FALSE, alpha = 0.4,
    position = position_nudge(x = rain_height + .05)) +
  # Rain
  geom_point(aes(colour = age_group), size = 2, alpha = .5, show.legend = FALSE, 
              position = position_jitter(width = rain_height, height = 0)) +
  # Boxplots
  geom_boxplot(width = rain_height, alpha = 0.4, show.legend = FALSE, 
               outlier.shape = NA,
               position = position_nudge(x = -rain_height*2)) +
  # Mean and SE point in the cloud
  stat_summary(fun.data = mean_cl_normal, mapping = aes(color = age_group), show.legend = FALSE,
               position = position_nudge(x = rain_height * 3)) +
  # Adjust layout
  scale_x_discrete(name = "", expand = c(rain_height*3, 0, 0, 0.7)) +
  scale_y_continuous(name = "Recall Score",
                     breaks = seq(0, 100, 10), 
                     limits = c(0, 100)) +
  coord_flip() +
  facet_wrap(~factor(test_condition, 
                     levels = c("Immediate", "Delayed"), 
                     labels = c("Immediate", "Delayed")), 
             nrow = 2) +
  # Custom colours and theme
  scale_fill_brewer(palette = "Dark2", name = "Age Group") +
  scale_colour_brewer(palette = "Dark2") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        legend.position = c(0.8, 0.8),
        legend.background = element_rect(fill = "white", color = "white"))

```
```{r}
# Setting the height for the rain elements
rain_height <- .1

# Create the Raincloud plot
ggplot(data_raw, aes(x = "", y = recall_score, fill = age_group)) +
  # Clouds
  geom_flat_violin(trim=FALSE, alpha = 0.4, position = position_nudge(x = rain_height + .05), adjust = 1.5) +
  # Rain
  geom_point(aes(color = age_group), size = 2, alpha = .6, position = position_jitter(width = rain_height, height = 0)) +
  # Boxplots
  geom_boxplot(width = rain_height / 3, alpha = 0.6, show.legend = FALSE, outlier.shape = NA, position = position_nudge(x = -rain_height*2)) +
  # Mean and SE point in the cloud
  stat_summary(fun.data = mean_cl_normal, mapping = aes(color = age_group), show.legend = FALSE, position = position_nudge(x = rain_height * 3)) +
  # Adjust layout
  scale_x_discrete(name = "", expand = c(rain_height*3, 0, 0, 0.7)) +
  scale_y_continuous(name = "Recall Score", breaks = seq(0, 100, 10), limits = c(0, 100)) +
  coord_flip() +
  facet_wrap(~factor(test_condition, levels = c("Immediate", "Delayed"), labels = c("Immediate", "Delayed")), nrow = 2) +
  # Custom colours and theme
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), name = "Age Group") +
  scale_color_manual(values = c("#1b9e77", "#d95f02", "#7570b3")) +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_line(size = .1, color = "grey80"),
    panel.background = element_rect(fill = "white", color = NA),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(size = 14, face = "bold"),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    legend.background = element_rect(fill = "white", color = "white"),
    legend.box.background = element_rect(color = "white")
  ) +
  labs(title = "Recall Scores by Age Group and Test Condition")

```




# Write to disk

```{r}

# in case this dir doesn't exist, create it
dir.create("../data/processed/")

# save data to disk in that dir
write_csv(data_processed, "../data/processed/data_processed.csv")

```

# Create codebook template for the processed data


```{r}
if(!file.exists("../data/processed/data_processed_codebook.xlsx")){
  # convert the column names to a df
  codebook_template <- data.frame(variable = colnames(data_processed)) |>
    mutate(explanation = NA)
  # write to disk as an excel file
  openxlsx::write.xlsx(codebook_template, file = "../data/processed/data_processed_codebook.xlsx")
}
```

Note that there are other ways of automatically creating more elaborate codebooks from your datasets. These often contain information about min/max/mean/SD, distribution, etc. For example:

- Ruben Arslan's {codebook}
  - [R package with How-Tos](https://rubenarslan.github.io/codebook/)
  - [Tutorial](https://rubenarslan.github.io/codebook/articles/codebook_tutorial.html)
  - [Article](https://journals.sagepub.com/doi/full/10.1177/2515245919838783)
- Petersen & Ekstr√∏m's {dataReporter}
  - [Article](https://www.jstatsoft.org/article/view/v090i06)
  - [Blog](https://sandsynligvis.dk/2017/08/21/datamaid-your-personal-assistant-for-cleaning-up-the-data-cleaning-process/)
  - [R package](https://cran.r-project.org/web/packages/dataReporter/index.html)

# Session info

```{r}

sessionInfo()

```


